# encoding: utf-8
import os
import utils
from itertools import combinations
def get_sim(apk_path1, apk_path2):
    try:
        cmd = "E:\\WorkPlaces\\PY_WorkPlace\\AndroidMalware\\test\malware_sim\\androsim-1.2.exe -i {0} {1}".format(apk_path1,apk_path2)
        s = os.popen(cmd)
        res = s.read()
        s.close()
        res = res.split("-->")[1].split(" ")[2]
        res = float(res[:-1])
    except Exception as e:
        print(e)
        res = None
    return res

def get_malwares(dir_path, num_limit=2):
    sub_dirs = utils.get_files_from_dir(dir_path)

    res = {}
    for sub_dir in sub_dirs:
        files = utils.get_files_from_dir(sub_dir,file_type=".apk")
        if len(files) >= num_limit:
            dir_name = sub_dir.split("\\")[-1]
            res[dir_name] = files
    return res

if __name__ == "__main__":
    # drebin数据集
    drebin_dir_path = "E:\\movies\\drebin-dataset"
    drebin_files = get_malwares(drebin_dir_path,num_limit=2)

    drebin_all_sims = {}
    for family_name, files in drebin_files.items():
        sims = []
        print(family_name,len(files))
        coms = combinations(files,2)
        for com in coms:
            sim = get_sim(com[0],com[1])
            if sim != None:
                print(com,sim)
                sims.append((len(files),com[0],com[1],sim))
        drebin_all_sims[family_name] = sims
    utils.save_pkl(drebin_all_sims,"drebin_all_sims.pkl")