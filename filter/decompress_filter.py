# encoding: utf-8
import utils
from database import MySQLUtils
import config
def filter_by_dex(decompress_dir_path):
    """
    按两条规则：1. 无dex文件；有多个dex文件
    :param dir_path:
    :return:
    """

    dir_paths = utils.get_files_from_dir(decompress_dir_path)

    values=[]
    count = 0
    for dir_path in dir_paths:
        dex_files = utils.get_files_from_dir(dir_path,file_type=".dex")

        MD5 = dir_path.split("\\")[-1].split("_")[-1]

        valid = ''
        if len(dex_files) == 1:
            valid = '1'
            count += 1
            print("pass ",dir_path)
        elif len(dex_files) == 0:
            valid = "no dex file;"
            print(valid, dir_path)
        elif len(dex_files) > 1:
            valid = "multiple dex file;"
            print(valid, dir_path)

        values.append([MD5,valid,dir_path])

    print("Total get {0} dir paths".format(len(dir_paths)))
    print("{0} files pass the filter".format(count))
    #print(values)

    print("start saving to database")
    mysql = MySQLUtils.MyPymysqlPool()
    insert_cmd = "INSERT INTO malware_info (MD5,VALID,DECOMPRESS_DIR_PATH) VALUES(%s,%s,%s)"
    mysql.insertMany(insert_cmd, values)
    mysql.dispose()

if __name__ == "__main__":
    filter_by_dex(config.DATA_MALWARE_DECOMPRESS_PATH)
