# encoding: utf-8
import os
import config
import log
import utils
import db_apis

LOG_FILE = "dex2java.txt"

def decompile_java(dex_path, des_path):
    try:
        jadx_path = config.LIB_JADX_PATH
        cmd ="{0} --show-bad-code --no-imports --deobf -d {1} {2}".format(jadx_path,des_path,dex_path)
        os.system(cmd)
        print(cmd)
    except Exception as e:
        log.print_and_write(LOG_FILE, e, type="ERROR", remark=dex_path)

def get_valid_decompress_dir_path():
    dir_paths = utils.get_files_from_dir(config.DATA_BENIGN_DECOMPRESS_PATH)
    print("Total get {0} dir paths".format(len(dir_paths)))

    res=[]
    count = 0
    for dir_path in dir_paths:
        dex_files = utils.get_files_from_dir(dir_path,file_type=".dex")

        if len(dex_files) == 1:
            count += 1
            if count % 100 == 0:
                print(count," pass")
            res.append(dir_path)

    print("Total get {0} dir paths".format(len(dir_paths)))
    print("{0} files pass the filter".format(count))

    return res

if __name__ == "__main__":

    pkl_path = "valid_benigh_decompress_dirs.pkl"
    if os.path.exists(pkl_path):
        dir_paths = utils.load_pkl(pkl_path)
    else:
        dir_paths = get_valid_decompress_dir_path()
        utils.save_pkl(dir_paths,pkl_path)

    log.print_and_write(LOG_FILE,"Total get {0} dir paths".format(len(dir_paths)))

    des_paths = []
    for dir_path in dir_paths:
        des_path = os.path.join(config.DATA_BENIGN_DECOMPILE_JAVA_PATH,dir_path.split("\\")[-1])
        if os.path.exists(des_path) == False:
            des_paths.append((dir_path,des_path))

    log.print_and_write(LOG_FILE,"{0} files has been decompiled".format(len(dir_paths)-len(des_paths)))

    log.print_and_write(LOG_FILE, "{0} files need to decompiled".format(len(des_paths)))
    count = len(des_paths)
    for src_path, des_path in des_paths:
        dex_path = os.path.join(src_path,"classes.dex")
        decompile_java(dex_path,des_path)
        count -= 1
        print("{0} files need to decompiled".format(count))





