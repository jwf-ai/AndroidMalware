# encoding: utf-8

import config
from database import MySQLUtils
import utils
import os

DEVICE = "M"
DECOMPILE_TYPE="SMALI"

def update_db(src_md5, des_dir_path, mysql):
    print("Get {0} src files".format(len(src_md5)))

    des_files = utils.get_files_from_dir(des_dir_path)
    print("Get {0} des files from {1}".format(len(des_files), des_dir_path))

    if DEVICE == 'M':
        des_md5 = list(x.split("\\")[-1].split("_")[-1] for x in des_files)
    else:
        pass

    print("{0} files occur error in decompile {1} process".format(len(src_md5)-len(des_files),DECOMPILE_TYPE))

    if DEVICE == "M":
        print("start update db")
        for md5 in src_md5:
            if md5 not in des_md5:
                valid = "decompile {0} error;".format(DECOMPILE_TYPE)
                sql = "UPDATE malware_info SET VALID=%s WHERE MD5=%s"
                print(sql%(valid,md5))
                mysql.update(sql,(valid,md5))
            else:
                decompile_path = os.path.join(des_dir_path,"VirusShare_"+md5)
                sql = "UPDATE malware_info SET DECOMPILE_{0}_DIR_PATH=%s WHERE MD5=%s".format(DECOMPILE_TYPE)
                print(sql % (decompile_path, md5))
                mysql.update(sql,(decompile_path,md5))

    else:
        pass

def get_md5(mysql):
    if DEVICE == "M":
        sql = "SELECT MD5 FROM malware_info WHERE VALID='1'"
        res = mysql.getAll(sql)
    else:
        pass

    res = list(str(x['MD5'],encoding='utf-8') for x in res)
    return res


if __name__ == "__main__":
    mysql = MySQLUtils.MyPymysqlPool()

    if DEVICE == "M":
        if DECOMPILE_TYPE == "JAVA":
            des_dir_path = config.DATA_MALWARE_DECOMPILE_JAVA_PATH
        else:
            des_dir_path = config.DATA_MALWARE_DECOMPILE_SMALI_PATH
    else:
        pass

    src_md5 = get_md5(mysql)
    update_db(src_md5,des_dir_path,mysql)

    mysql.dispose()


