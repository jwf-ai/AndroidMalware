# encoding: utf-8

import config
from database import MySQLUtils
import utils

DEVICE = "M"

def update_db(dataset_dir_path, decompress_dir_path):
    origin_files = utils.get_files_from_dir(dataset_dir_path)
    print("Get {0} origin files from dataset".format(len(origin_files)))

    decompress_subdirs = utils.get_files_from_dir(decompress_dir_path)
    if DEVICE == 'M':
        decompress_files = list(x.split("\\")[-1] for x in decompress_subdirs)
    else:
        pass

    print("Get {0} decompress subdir paths".format(len(decompress_files)))
    print("{0} files occur error in decompress process".format(len(origin_files)-len(decompress_files)))

    if DEVICE == "M":
        print("start insert malware file info that not decompressed correctly")
        for file in origin_files:
            filename = file.split("\\")[-1]
            if filename not in decompress_files:
                md5 = filename.split("_")[-1]
                valid = "decompress error;"
                sql = "INSERT INTO malware_info(MD5,VALID) VALUES(%s,%s)"
                print("Error in decompress:",filename)
                mysql = MySQLUtils.MyPymysqlPool()
                mysql.insert(sql,(md5,valid))
                mysql.dispose()
    else:
        pass


if __name__ == "__main__":
    if DEVICE == "M":
        dataset_dir_path = config.DATA_MALWARE_SET_PATH
        decompress_dir_path = config.DATA_MALWARE_DECOMPRESS_PATH
    else:
        pass

    update_db(dataset_dir_path,decompress_dir_path)


